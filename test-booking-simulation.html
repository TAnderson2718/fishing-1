<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„è®¢æµç¨‹æ¨¡æ‹Ÿæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px; }
        .step { margin: 10px 0; padding: 10px; background: #f5f5f5; border-left: 4px solid #007bff; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>é¢„è®¢æµç¨‹æ¨¡æ‹Ÿæµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>è¿™ä¸ªæµ‹è¯•å°†æ¨¡æ‹Ÿå®Œæ•´çš„é¢„è®¢æµç¨‹ï¼Œæ£€æŸ¥æ¯ä¸ªæ­¥éª¤æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        <p><strong>æ³¨æ„ï¼š</strong>è¿™æ˜¯æ¨¡æ‹Ÿæµ‹è¯•ï¼Œä¸ä¼šå®é™…åˆ›å»ºè®¢å•ï¼Œåªæ£€æŸ¥æ•°æ®ç»“æ„å’Œå‡½æ•°æ˜¯å¦æ­£ç¡®ã€‚</p>
    </div>

    <div class="test-section">
        <h2>é¢„è®¢æµç¨‹æµ‹è¯•</h2>
        <button onclick="runBookingSimulation()">è¿è¡Œé¢„è®¢æµç¨‹æ¨¡æ‹Ÿ</button>
        <button onclick="testPaymentFlow()">æµ‹è¯•æ”¯ä»˜æµç¨‹</button>
        <button onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
        <button onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function runBookingSimulation() {
            log('ğŸš€ å¼€å§‹é¢„è®¢æµç¨‹æ¨¡æ‹Ÿæµ‹è¯•...', 'info');
            
            // æ­¥éª¤1: æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            setTimeout(() => {
                testUserLogin();
            }, 100);
            
            // æ­¥éª¤2: æ£€æŸ¥æ´»åŠ¨æ•°æ®
            setTimeout(() => {
                testActivityData();
            }, 300);
            
            // æ­¥éª¤3: æ¨¡æ‹Ÿé€‰æ‹©æ´»åŠ¨
            setTimeout(() => {
                testActivitySelection();
            }, 500);
            
            // æ­¥éª¤4: æ¨¡æ‹Ÿå¡«å†™é¢„è®¢ä¿¡æ¯
            setTimeout(() => {
                testBookingForm();
            }, 700);
            
            // æ­¥éª¤5: æ¨¡æ‹Ÿè®¢å•æ•°æ®åˆ›å»º
            setTimeout(() => {
                testOrderCreation();
            }, 900);
            
            setTimeout(() => {
                log('âœ… é¢„è®¢æµç¨‹æ¨¡æ‹Ÿæµ‹è¯•å®Œæˆ', 'success');
            }, 1100);
        }

        function testUserLogin() {
            try {
                const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (user && user.role === 'customer') {
                    log(`âœ… ç”¨æˆ·ç™»å½•æ£€æŸ¥é€šè¿‡: ${user.name}`, 'success');
                    log(`   - ç”¨æˆ·ID: ${user.id}`, 'info');
                    log(`   - ç”µè¯: ${user.phone || 'æœªè®¾ç½®'}`, 'info');
                    log(`   - ä¼šå‘˜çŠ¶æ€: ${user.isMember ? 'æ˜¯' : 'å¦'}`, 'info');
                    return true;
                } else {
                    log('âŒ ç”¨æˆ·æœªç™»å½•æˆ–è§’è‰²ä¸æ­£ç¡®', 'error');
                    return false;
                }
            } catch (error) {
                log(`âŒ ç”¨æˆ·ç™»å½•æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        function testActivityData() {
            try {
                const activities = JSON.parse(localStorage.getItem('activities') || '[]');
                if (activities.length > 0) {
                    log(`âœ… æ´»åŠ¨æ•°æ®æ£€æŸ¥é€šè¿‡: ${activities.length} ä¸ªæ´»åŠ¨`, 'success');
                    
                    const firstActivity = activities[0];
                    log(`   - ç¤ºä¾‹æ´»åŠ¨: ${firstActivity.title}`, 'info');
                    log(`   - ä»·æ ¼: Â¥${firstActivity.price}`, 'info');
                    log(`   - ä¼šå‘˜ä»·: Â¥${firstActivity.memberPrice}`, 'info');
                    log(`   - æ—¶é—´æ®µæ•°é‡: ${firstActivity.schedule?.length || 0}`, 'info');
                    
                    return firstActivity;
                } else {
                    log('âŒ æ²¡æœ‰æ´»åŠ¨æ•°æ®', 'error');
                    return null;
                }
            } catch (error) {
                log(`âŒ æ´»åŠ¨æ•°æ®æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        function testActivitySelection() {
            try {
                const activities = JSON.parse(localStorage.getItem('activities') || '[]');
                if (activities.length === 0) {
                    log('âŒ æ— æ³•æµ‹è¯•æ´»åŠ¨é€‰æ‹©ï¼šæ²¡æœ‰æ´»åŠ¨æ•°æ®', 'error');
                    return;
                }
                
                const selectedActivity = activities[0];
                log(`âœ… æ¨¡æ‹Ÿé€‰æ‹©æ´»åŠ¨: ${selectedActivity.title}`, 'success');
                
                if (selectedActivity.schedule && selectedActivity.schedule.length > 0) {
                    const availableSchedule = selectedActivity.schedule.find(s => s.available > 0);
                    if (availableSchedule) {
                        log(`âœ… æ‰¾åˆ°å¯ç”¨æ—¶é—´æ®µ: ${availableSchedule.date} ${availableSchedule.time}`, 'success');
                        log(`   - å¯ç”¨äººæ•°: ${availableSchedule.available}`, 'info');
                        return { selectedActivity, selectedSchedule: availableSchedule };
                    } else {
                        log('âš ï¸ æ‰€æœ‰æ—¶é—´æ®µéƒ½å·²æ»¡å‘˜', 'warning');
                        return null;
                    }
                } else {
                    log('âŒ æ´»åŠ¨æ²¡æœ‰æ—¶é—´æ®µæ•°æ®', 'error');
                    return null;
                }
            } catch (error) {
                log(`âŒ æ´»åŠ¨é€‰æ‹©æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        function testBookingForm() {
            try {
                const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
                const activities = JSON.parse(localStorage.getItem('activities') || '[]');
                
                if (!user || activities.length === 0) {
                    log('âŒ æ— æ³•æµ‹è¯•é¢„è®¢è¡¨å•ï¼šç¼ºå°‘ç”¨æˆ·æˆ–æ´»åŠ¨æ•°æ®', 'error');
                    return;
                }
                
                const selectedActivity = activities[0];
                const selectedSchedule = selectedActivity.schedule?.[0];
                const participants = 1;
                
                if (!selectedSchedule) {
                    log('âŒ æ— æ³•æµ‹è¯•é¢„è®¢è¡¨å•ï¼šæ²¡æœ‰å¯ç”¨æ—¶é—´æ®µ', 'error');
                    return;
                }
                
                log('âœ… æ¨¡æ‹Ÿå¡«å†™é¢„è®¢è¡¨å•', 'success');
                log(`   - å‚ä¸äººæ•°: ${participants}`, 'info');
                log(`   - é€‰æ‹©æ—¶é—´: ${selectedSchedule.date} ${selectedSchedule.time}`, 'info');
                
                const price = user.isMember ? selectedActivity.memberPrice : selectedActivity.price;
                const totalPrice = price * participants;
                
                log(`   - å•ä»·: Â¥${price} ${user.isMember ? '(ä¼šå‘˜ä»·)' : '(æ™®é€šä»·)'}`, 'info');
                log(`   - æ€»ä»·: Â¥${totalPrice}`, 'info');
                
                return {
                    selectedActivity,
                    selectedSchedule,
                    participants,
                    price,
                    totalPrice
                };
            } catch (error) {
                log(`âŒ é¢„è®¢è¡¨å•æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        function testOrderCreation() {
            try {
                const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
                const activities = JSON.parse(localStorage.getItem('activities') || '[]');
                
                if (!user || activities.length === 0) {
                    log('âŒ æ— æ³•æµ‹è¯•è®¢å•åˆ›å»ºï¼šç¼ºå°‘ç”¨æˆ·æˆ–æ´»åŠ¨æ•°æ®', 'error');
                    return;
                }
                
                const selectedActivity = activities[0];
                const selectedSchedule = selectedActivity.schedule?.[0];
                const participants = 1;
                const price = user.isMember ? selectedActivity.memberPrice : selectedActivity.price;
                const totalPrice = price * participants;
                
                // æ¨¡æ‹Ÿåˆ›å»ºè®¢å•æ•°æ®
                const orderData = {
                    customerId: user.id,
                    customerName: user.name,
                    customerPhone: user.phone || '',
                    activityId: selectedActivity.id,
                    activityTitle: selectedActivity.title,
                    activityDate: selectedSchedule.date,
                    date: selectedSchedule.date,
                    time: selectedSchedule.time,
                    participants: participants,
                    unitPrice: price,
                    originalPrice: selectedActivity.price * participants,
                    finalPrice: totalPrice,
                    totalAmount: totalPrice,
                    isMemberPrice: user.isMember,
                    status: 'pending',
                    paymentStatus: 'pending'
                };
                
                log('âœ… æ¨¡æ‹Ÿåˆ›å»ºè®¢å•æ•°æ®', 'success');
                log('ğŸ“‹ è®¢å•æ•°æ®ç»“æ„:', 'info');
                
                // æ£€æŸ¥å¿…éœ€å­—æ®µ
                const requiredFields = [
                    'customerId', 'customerName', 'activityId', 'activityTitle',
                    'date', 'time', 'participants', 'totalAmount', 'status', 'paymentStatus'
                ];
                
                let allFieldsPresent = true;
                for (const field of requiredFields) {
                    if (orderData[field] !== undefined && orderData[field] !== null) {
                        log(`   âœ… ${field}: ${orderData[field]}`, 'success');
                    } else {
                        log(`   âŒ ç¼ºå°‘å­—æ®µ: ${field}`, 'error');
                        allFieldsPresent = false;
                    }
                }
                
                if (allFieldsPresent) {
                    log('âœ… è®¢å•æ•°æ®ç»“æ„éªŒè¯é€šè¿‡', 'success');
                } else {
                    log('âŒ è®¢å•æ•°æ®ç»“æ„éªŒè¯å¤±è´¥', 'error');
                }
                
                return orderData;
            } catch (error) {
                log(`âŒ è®¢å•åˆ›å»ºæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                return null;
            }
        }

        function testPaymentFlow() {
            log('ğŸ’³ å¼€å§‹æ”¯ä»˜æµç¨‹æµ‹è¯•...', 'info');
            
            // æ¨¡æ‹Ÿæ”¯ä»˜è®°å½•
            const mockPaymentRecord = {
                id: `pay_${Date.now()}`,
                amount: 228,
                method: 'alipay',
                status: 'completed',
                createdAt: new Date().toISOString(),
                completedAt: new Date().toISOString(),
                transactionId: `txn_${Date.now()}_test123`
            };
            
            log('âœ… æ¨¡æ‹Ÿæ”¯ä»˜è®°å½•åˆ›å»º', 'success');
            log(`   - æ”¯ä»˜ID: ${mockPaymentRecord.id}`, 'info');
            log(`   - é‡‘é¢: Â¥${mockPaymentRecord.amount}`, 'info');
            log(`   - æ”¯ä»˜æ–¹å¼: ${mockPaymentRecord.method}`, 'info');
            log(`   - çŠ¶æ€: ${mockPaymentRecord.status}`, 'info');
            
            // æ£€æŸ¥æ”¯ä»˜å¤„ç†å‡½æ•°æ˜¯å¦å­˜åœ¨
            log('ğŸ” æ£€æŸ¥æ”¯ä»˜å¤„ç†å‡½æ•°...', 'info');
            log('   - handlePaymentSuccess: åº”è¯¥åœ¨CustomerHomeç»„ä»¶ä¸­å®šä¹‰', 'info');
            log('   - handlePaymentCancel: åº”è¯¥åœ¨CustomerHomeç»„ä»¶ä¸­å®šä¹‰', 'info');
            log('   - handlePaymentError: åº”è¯¥åœ¨CustomerHomeç»„ä»¶ä¸­å®šä¹‰', 'info');
            
            log('âœ… æ”¯ä»˜æµç¨‹æµ‹è¯•å®Œæˆ', 'success');
        }

        function testErrorHandling() {
            log('ğŸ›¡ï¸ å¼€å§‹é”™è¯¯å¤„ç†æµ‹è¯•...', 'info');
            
            // æµ‹è¯•å„ç§é”™è¯¯åœºæ™¯
            const errorScenarios = [
                'ç”¨æˆ·æœªç™»å½•',
                'æ´»åŠ¨æ•°æ®ç¼ºå¤±',
                'æ—¶é—´æ®µå·²æ»¡å‘˜',
                'æ”¯ä»˜å¤±è´¥',
                'ç½‘ç»œé”™è¯¯'
            ];
            
            errorScenarios.forEach((scenario, index) => {
                setTimeout(() => {
                    log(`ğŸ” æµ‹è¯•é”™è¯¯åœºæ™¯: ${scenario}`, 'info');
                    log(`   - åº”è¯¥æ˜¾ç¤ºé€‚å½“çš„é”™è¯¯æ¶ˆæ¯`, 'info');
                    log(`   - åº”è¯¥æä¾›é‡è¯•æˆ–è¿”å›é€‰é¡¹`, 'info');
                }, index * 200);
            });
            
            setTimeout(() => {
                log('âœ… é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
            }, errorScenarios.length * 200 + 100);
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ é¢„è®¢æµç¨‹æ¨¡æ‹Ÿæµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('ğŸ’¡ ç‚¹å‡»"è¿è¡Œé¢„è®¢æµç¨‹æ¨¡æ‹Ÿ"å¼€å§‹æµ‹è¯•', 'info');
        };
    </script>
</body>
</html>
