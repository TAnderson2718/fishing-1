<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„è®¢æµç¨‹å…¼å®¹æ€§æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .flow-step {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #f9f9f9;
        }
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        .booking-form {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .order-summary {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .qr-code {
            text-align: center;
            padding: 20px;
            border: 2px dashed #007bff;
            border-radius: 8px;
            background: #f8f9ff;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”„ é¢„è®¢æµç¨‹å…¼å®¹æ€§æµ‹è¯•</h1>
        <p>æµ‹è¯•è·¯äºšé’“é±¼ä½“éªŒæ´»åŠ¨ï¼ˆ3å°æ—¶ï¼‰çš„å®Œæ•´é¢„è®¢æµç¨‹</p>
        
        <div>
            <button onclick="testCompleteFlow()">æµ‹è¯•å®Œæ•´æµç¨‹</button>
            <button onclick="testPaymentFlow()">æµ‹è¯•æ”¯ä»˜æµç¨‹</button>
            <button onclick="testQRGeneration()">æµ‹è¯•QRç ç”Ÿæˆ</button>
            <button onclick="testDataConsistency()">æµ‹è¯•æ•°æ®ä¸€è‡´æ€§</button>
            <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div id="log" class="log"></div>
        
        <div id="flowInterface"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('flowInterface').innerHTML = '';
        }

        // æ¨¡æ‹Ÿæ´»åŠ¨æ•°æ®
        const activity = {
            id: 1,
            title: "è·¯äºšé’“é±¼ä½“éªŒ",
            description: "ä¸“ä¸šæ•™ç»ƒæŒ‡å¯¼ï¼Œä½“éªŒè·¯äºšé’“é±¼çš„ä¹è¶£",
            category: "lure_fishing",
            price: 288,
            memberPrice: 228,
            duration: "3å°æ—¶",
            maxParticipants: 8,
            location: "ä¸œæ¹–é’“é±¼åŸºåœ°",
            features: ["ä¸“ä¸šæ•™ç»ƒ", "è£…å¤‡æä¾›", "é±¼è·ä¿è¯"],
            schedule: [
                { date: "2024-08-05", time: "08:00-11:00", available: 6 },
                { date: "2024-08-05", time: "14:00-17:00", available: 3 },
                { date: "2024-08-06", time: "08:00-11:00", available: 8 },
            ]
        };

        // æ¨¡æ‹Ÿå®¢æˆ·æ•°æ®
        const customer = {
            id: 7,
            name: "æµ‹è¯•ç”¨æˆ·",
            phone: "13800138007",
            email: "test@example.com",
            isMember: true
        };

        function testCompleteFlow() {
            log('ğŸš€ å¼€å§‹æµ‹è¯•å®Œæ•´é¢„è®¢æµç¨‹...', 'info');
            
            try {
                // æ­¥éª¤1: å®¢æˆ·æµè§ˆæ´»åŠ¨
                log('ğŸ‘€ æ­¥éª¤1: å®¢æˆ·æµè§ˆæ´»åŠ¨åˆ—è¡¨', 'info');
                log(`   æ‰¾åˆ°æ´»åŠ¨: ${activity.title}`, 'info');
                log(`   æ´»åŠ¨æ—¶é•¿: ${activity.duration}`, 'success');
                log(`   æ´»åŠ¨ä»·æ ¼: Â¥${activity.price} (ä¼šå‘˜ä»·: Â¥${activity.memberPrice})`, 'info');

                // æ­¥éª¤2: é€‰æ‹©æ—¶é—´
                log('ğŸ“… æ­¥éª¤2: é€‰æ‹©é¢„è®¢æ—¶é—´', 'info');
                const selectedSchedule = activity.schedule[0];
                log(`   é€‰æ‹©æ—¶é—´: ${selectedSchedule.date} ${selectedSchedule.time}`, 'info');
                
                // éªŒè¯æ—¶é—´æ®µä¸º3å°æ—¶
                const [start, end] = selectedSchedule.time.split('-');
                const startHour = parseInt(start.split(':')[0]);
                const endHour = parseInt(end.split(':')[0]);
                const duration = endHour - startHour;
                
                if (duration === 3) {
                    log(`   âœ… æ—¶é—´æ®µéªŒè¯é€šè¿‡: ${duration}å°æ—¶`, 'success');
                } else {
                    log(`   âŒ æ—¶é—´æ®µéªŒè¯å¤±è´¥: ${duration}å°æ—¶`, 'error');
                    return;
                }

                // æ­¥éª¤3: å¡«å†™é¢„è®¢ä¿¡æ¯
                log('ğŸ“ æ­¥éª¤3: å¡«å†™é¢„è®¢ä¿¡æ¯', 'info');
                const bookingData = {
                    customerId: customer.id,
                    customerName: customer.name,
                    customerPhone: customer.phone,
                    activityId: activity.id,
                    activityTitle: activity.title,
                    date: selectedSchedule.date,
                    time: selectedSchedule.time,
                    participants: 1,
                    unitPrice: customer.isMember ? activity.memberPrice : activity.price,
                    isMemberPrice: customer.isMember
                };
                
                log(`   å®¢æˆ·: ${bookingData.customerName}`, 'info');
                log(`   è”ç³»æ–¹å¼: ${bookingData.customerPhone}`, 'info');
                log(`   å‚ä¸äººæ•°: ${bookingData.participants}äºº`, 'info');
                log(`   å•ä»·: Â¥${bookingData.unitPrice}`, 'info');

                // æ­¥éª¤4: è®¡ç®—è´¹ç”¨
                log('ğŸ’° æ­¥éª¤4: è®¡ç®—é¢„è®¢è´¹ç”¨', 'info');
                const totalAmount = bookingData.unitPrice * bookingData.participants;
                log(`   æ€»é‡‘é¢: Â¥${totalAmount}`, 'info');
                if (customer.isMember) {
                    const savings = (activity.price - activity.memberPrice) * bookingData.participants;
                    log(`   ä¼šå‘˜ä¼˜æƒ : èŠ‚çœÂ¥${savings}`, 'success');
                }

                // æ­¥éª¤5: ç”Ÿæˆè®¢å•
                log('ğŸ“‹ æ­¥éª¤5: ç”Ÿæˆé¢„è®¢è®¢å•', 'info');
                const orderId = `ORD${Date.now()}`;
                const order = {
                    id: orderId,
                    ...bookingData,
                    totalAmount: totalAmount,
                    status: 'pending',
                    paymentStatus: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                log(`   è®¢å•å·: ${order.id}`, 'info');
                log(`   è®¢å•çŠ¶æ€: ${order.status}`, 'info');
                log('âœ… è®¢å•ç”ŸæˆæˆåŠŸ', 'success');

                displayBookingFlow(order);

            } catch (error) {
                log(`âŒ å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testPaymentFlow() {
            log('ğŸ’³ å¼€å§‹æµ‹è¯•æ”¯ä»˜æµç¨‹...', 'info');
            
            try {
                // æ¨¡æ‹Ÿè®¢å•
                const order = {
                    id: "ORD_TEST_001",
                    customerName: customer.name,
                    activityTitle: activity.title,
                    date: "2024-08-05",
                    time: "08:00-11:00",
                    participants: 1,
                    totalAmount: customer.isMember ? activity.memberPrice : activity.price,
                    status: 'pending',
                    paymentStatus: 'pending'
                };

                log('ğŸ’° å¤„ç†æ”¯ä»˜è¯·æ±‚...', 'info');
                log(`   è®¢å•å·: ${order.id}`, 'info');
                log(`   æ”¯ä»˜é‡‘é¢: Â¥${order.totalAmount}`, 'info');

                // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
                log('ğŸ”„ è¿æ¥æ”¯ä»˜ç½‘å…³...', 'info');
                setTimeout(() => {
                    log('âœ… æ”¯ä»˜æˆåŠŸ', 'success');
                    
                    // æ›´æ–°è®¢å•çŠ¶æ€
                    order.status = 'confirmed';
                    order.paymentStatus = 'paid';
                    order.paidAt = new Date().toISOString();
                    
                    log('ğŸ“‹ æ›´æ–°è®¢å•çŠ¶æ€...', 'info');
                    log(`   è®¢å•çŠ¶æ€: ${order.status}`, 'success');
                    log(`   æ”¯ä»˜çŠ¶æ€: ${order.paymentStatus}`, 'success');
                    
                    // ç”ŸæˆQRç 
                    testQRGeneration(order);
                    
                }, 1000);

            } catch (error) {
                log(`âŒ æ”¯ä»˜æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testQRGeneration(order = null) {
            log('ğŸ“± å¼€å§‹æµ‹è¯•QRç ç”Ÿæˆ...', 'info');
            
            try {
                if (!order) {
                    order = {
                        id: "ORD_QR_TEST",
                        customerName: customer.name,
                        activityTitle: activity.title,
                        date: "2024-08-05",
                        time: "08:00-11:00",
                        participants: 1,
                        status: 'confirmed',
                        paymentStatus: 'paid'
                    };
                }

                // ç”ŸæˆQRç å†…å®¹
                const qrContent = `QR_${order.id}_2024`;
                order.qrCode = qrContent;
                
                log('ğŸ”§ ç”ŸæˆQRç ...', 'info');
                log(`   QRç å†…å®¹: ${qrContent}`, 'info');
                log(`   åŒ…å«ä¿¡æ¯:`, 'info');
                log(`     - è®¢å•å·: ${order.id}`, 'info');
                log(`     - å®¢æˆ·: ${order.customerName}`, 'info');
                log(`     - æ´»åŠ¨: ${order.activityTitle}`, 'info');
                log(`     - æ—¶é—´: ${order.date} ${order.time} (3å°æ—¶)`, 'success');
                log(`     - äººæ•°: ${order.participants}äºº`, 'info');
                
                log('âœ… QRç ç”ŸæˆæˆåŠŸ', 'success');
                
                // æ¨¡æ‹ŸQRç éªŒè¯
                log('ğŸ” æµ‹è¯•QRç éªŒè¯...', 'info');
                if (order.qrCode && order.status === 'confirmed') {
                    log('âœ… QRç éªŒè¯é€šè¿‡', 'success');
                } else {
                    log('âŒ QRç éªŒè¯å¤±è´¥', 'error');
                }

                displayQRCode(order);

            } catch (error) {
                log(`âŒ QRç ç”Ÿæˆæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testDataConsistency() {
            log('ğŸ” å¼€å§‹æµ‹è¯•æ•°æ®ä¸€è‡´æ€§...', 'info');
            
            try {
                // æ£€æŸ¥æ´»åŠ¨æ•°æ®ä¸€è‡´æ€§
                log('ğŸ“Š æ£€æŸ¥æ´»åŠ¨æ•°æ®ä¸€è‡´æ€§...', 'info');
                
                // éªŒè¯æ—¶é•¿
                if (activity.duration === "3å°æ—¶") {
                    log('âœ… æ´»åŠ¨æ—¶é•¿æ•°æ®ä¸€è‡´: 3å°æ—¶', 'success');
                } else {
                    log(`âŒ æ´»åŠ¨æ—¶é•¿æ•°æ®ä¸ä¸€è‡´: ${activity.duration}`, 'error');
                }

                // éªŒè¯æ—¶é—´å®‰æ’
                log('ğŸ• æ£€æŸ¥æ—¶é—´å®‰æ’ä¸€è‡´æ€§...', 'info');
                let allSchedulesValid = true;
                
                activity.schedule.forEach((schedule, index) => {
                    const [start, end] = schedule.time.split('-');
                    const startHour = parseInt(start.split(':')[0]);
                    const endHour = parseInt(end.split(':')[0]);
                    const duration = endHour - startHour;
                    
                    if (duration === 3) {
                        log(`   âœ… æ—¶é—´æ®µ ${index + 1} ä¸€è‡´: ${schedule.time} (${duration}å°æ—¶)`, 'success');
                    } else {
                        log(`   âŒ æ—¶é—´æ®µ ${index + 1} ä¸ä¸€è‡´: ${schedule.time} (${duration}å°æ—¶)`, 'error');
                        allSchedulesValid = false;
                    }
                });

                if (allSchedulesValid) {
                    log('âœ… æ‰€æœ‰æ—¶é—´å®‰æ’æ•°æ®ä¸€è‡´', 'success');
                }

                // æ£€æŸ¥ä»·æ ¼æ•°æ®
                log('ğŸ’° æ£€æŸ¥ä»·æ ¼æ•°æ®...', 'info');
                if (activity.price > 0 && activity.memberPrice > 0 && activity.memberPrice < activity.price) {
                    log('âœ… ä»·æ ¼æ•°æ®æ­£å¸¸', 'success');
                    log(`   åŸä»·: Â¥${activity.price}`, 'info');
                    log(`   ä¼šå‘˜ä»·: Â¥${activity.memberPrice}`, 'info');
                } else {
                    log('âŒ ä»·æ ¼æ•°æ®å¼‚å¸¸', 'error');
                }

                // æ£€æŸ¥å®¹é‡æ•°æ®
                log('ğŸ‘¥ æ£€æŸ¥å®¹é‡æ•°æ®...', 'info');
                if (activity.maxParticipants > 0) {
                    log(`âœ… æœ€å¤§å®¹é‡: ${activity.maxParticipants}äºº`, 'success');
                } else {
                    log('âŒ å®¹é‡æ•°æ®å¼‚å¸¸', 'error');
                }

                log('ğŸ¯ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ', 'success');

            } catch (error) {
                log(`âŒ æ•°æ®ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function displayBookingFlow(order) {
            const interfaceElement = document.getElementById('flowInterface');
            
            interfaceElement.innerHTML = `
                <div class="flow-step">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <h4>æ´»åŠ¨é€‰æ‹©</h4>
                    </div>
                    <p><strong>æ´»åŠ¨:</strong> ${activity.title}</p>
                    <p><strong>æ—¶é•¿:</strong> <span class="highlight">${activity.duration}</span></p>
                    <p><strong>åœ°ç‚¹:</strong> ${activity.location}</p>
                </div>

                <div class="flow-step">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <h4>æ—¶é—´é€‰æ‹©</h4>
                    </div>
                    <p><strong>æ—¥æœŸ:</strong> ${order.date}</p>
                    <p><strong>æ—¶é—´:</strong> <span class="highlight">${order.time}</span></p>
                    <p><strong>å¯é¢„è®¢:</strong> ${activity.schedule[0].available}äºº</p>
                </div>

                <div class="flow-step">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <h4>é¢„è®¢ä¿¡æ¯</h4>
                    </div>
                    <div class="booking-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>å®¢æˆ·å§“å:</label>
                                <input type="text" value="${order.customerName}" readonly>
                            </div>
                            <div class="form-group">
                                <label>è”ç³»ç”µè¯:</label>
                                <input type="text" value="${order.customerPhone}" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å‚ä¸äººæ•°:</label>
                                <input type="number" value="${order.participants}" readonly>
                            </div>
                            <div class="form-group">
                                <label>å•ä»·:</label>
                                <input type="text" value="Â¥${order.unitPrice}" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flow-step">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <h4>è®¢å•ç¡®è®¤</h4>
                    </div>
                    <div class="order-summary">
                        <p><strong>è®¢å•å·:</strong> ${order.id}</p>
                        <p><strong>æ´»åŠ¨:</strong> ${order.activityTitle}</p>
                        <p><strong>æ—¶é—´:</strong> ${order.date} ${order.time} (3å°æ—¶)</p>
                        <p><strong>äººæ•°:</strong> ${order.participants}äºº</p>
                        <p><strong>æ€»é‡‘é¢:</strong> Â¥${order.totalAmount}</p>
                        ${order.isMemberPrice ? '<p><strong>ä¼šå‘˜ä¼˜æƒ :</strong> å·²äº«å—ä¼šå‘˜ä»·æ ¼</p>' : ''}
                    </div>
                    
                    <button onclick="log('ğŸ’³ è·³è½¬åˆ°æ”¯ä»˜é¡µé¢...', 'info'); testPaymentFlow()">
                        ç¡®è®¤å¹¶æ”¯ä»˜
                    </button>
                </div>
            `;
        }

        function displayQRCode(order) {
            const interfaceElement = document.getElementById('flowInterface');
            
            interfaceElement.innerHTML += `
                <div class="flow-step">
                    <div class="step-header">
                        <div class="step-number">5</div>
                        <h4>æ”¯ä»˜æˆåŠŸ</h4>
                    </div>
                    <div class="qr-code">
                        <h4>ğŸ“± é¢„è®¢ç¡®è®¤QRç </h4>
                        <div style="font-size: 24px; margin: 20px 0;">
                            ğŸ“± ${order.qrCode}
                        </div>
                        <p>è¯·ä¿å­˜æ­¤QRç ï¼Œåˆ°åœºæ—¶å‡ºç¤ºç»™å·¥ä½œäººå‘˜æ‰«æç¡®è®¤</p>
                        <p><strong>æ´»åŠ¨ä¿¡æ¯:</strong></p>
                        <p>${order.activityTitle} | ${order.date} ${order.time} | ${order.participants}äºº</p>
                    </div>
                    
                    <button onclick="log('ğŸ“± QRç å·²ä¿å­˜åˆ°ç›¸å†Œ', 'success')">ä¿å­˜QRç </button>
                    <button onclick="log('ğŸ“§ é¢„è®¢ç¡®è®¤é‚®ä»¶å·²å‘é€', 'success')">å‘é€é‚®ä»¶</button>
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.onload = function() {
            log('ğŸš€ é¢„è®¢æµç¨‹å…¼å®¹æ€§æµ‹è¯•å¼€å§‹', 'info');
            log('ğŸ¯ æµ‹è¯•ç›®æ ‡: éªŒè¯è·¯äºšé’“é±¼ä½“éªŒæ´»åŠ¨(3å°æ—¶)çš„å®Œæ•´é¢„è®¢æµç¨‹', 'info');
            log('', 'info');
            testCompleteFlow();
        };
    </script>
</body>
</html>
